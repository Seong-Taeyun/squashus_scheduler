<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <title>스쿼셔스 스케줄러</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #2a2d5f;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
      }

      h1 {
        color: #ff8c1a;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      h1 img {
        height: 80px;
        width: auto;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 1.8em;
          flex-direction: column;
          gap: 10px;
        }

        h1 img {
          height: 60px;
        }
      }

      .section {
        margin-bottom: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
      }

      .section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 3px solid #ff8c1a;
        padding-bottom: 10px;
      }

      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .three-column {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      @media (max-width: 1200px) {
        .two-column {
          grid-template-columns: 1fr;
        }
        .three-column {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
          border-radius: 15px;
        }

        h1 {
          font-size: 1.8em;
          margin-bottom: 20px;
        }

        .section {
          padding: 15px;
          margin-bottom: 20px;
        }

        .section h2 {
          font-size: 1.2em;
        }

        .btn {
          padding: 10px 20px;
          font-size: 14px;
        }

        .btn-small {
          padding: 8px 12px;
          font-size: 13px;
        }

        .button-group {
          flex-direction: column;
          align-items: stretch;
        }

        .button-group .btn {
          width: 100%;
        }

        .add-staff-btn {
          flex-direction: column;
        }

        .add-staff-btn .btn {
          width: 100%;
        }

        .month-selector {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }

        .month-selector input {
          width: 100%;
        }

        .result-table {
          font-size: 0.85em;
        }

        .result-table th,
        .result-table td {
          padding: 8px 6px;
        }

        .schedule-item {
          flex-direction: column;
          gap: 10px;
          align-items: stretch;
        }

        .schedule-actions {
          flex-direction: column;
        }

        .schedule-actions .btn {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        h1 {
          font-size: 1.5em;
        }

        .section h2 {
          font-size: 1.1em;
        }

        .role-badge {
          font-size: 0.75em;
          padding: 4px 8px;
        }

        .unavailable-dates {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }

        .date-checkbox {
          padding: 6px;
          font-size: 0.85em;
        }
      }

      .firebase-status {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        font-size: 1.1em;
      }

      .firebase-connected {
        background: #d4edda;
        color: #155724;
      }

      .firebase-disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .staff-input {
        display: grid;
        gap: 15px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }

      .staff-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
      }

      .staff-item label {
        font-weight: 600;
        min-width: 80px;
        color: #555;
      }

      .staff-item input {
        flex: 1;
        min-width: 150px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .staff-item input:focus {
        outline: none;
        border-color: #ff8c1a;
      }

      .staff-item button {
        padding: 8px 15px;
        background: #e74c3c;
        color: white;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .staff-item button:hover {
        background: #c0392b;
      }

      @media (max-width: 768px) {
        .staff-item {
          gap: 10px;
          padding: 12px;
        }

        .staff-item .role-badge {
          order: 1;
          width: 100%;
          text-align: center;
        }

        .staff-item label {
          order: 2;
          min-width: 60px;
        }

        .staff-item input {
          order: 3;
          flex: 1;
          min-width: 0;
          width: 100%;
        }

        .staff-item button {
          order: 4;
          padding: 8px 12px;
          font-size: 14px;
        }
      }

      .role-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        color: white;
        min-width: 60px;
        text-align: center;
      }

      .role-leader {
        background: #8e3be6;
      }

      .role-lesson {
        background: #3498db;
      }

      .role-general {
        background: #2ecc71;
      }

      .add-staff-btn {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .region-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .region-card .region-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .region-card .region-name-input {
        flex: 1;
        min-width: 150px;
        padding: 8px 12px;
        border: 2px solid #ff8c1a;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        color: #ff8c1a;
      }

      .region-card .region-name-input:focus {
        outline: none;
        border-color: #764ba2;
      }

      .region-color-picker {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 35px;
        height: 35px;
        background-color: transparent;
        border: none;
        cursor: pointer;
        border-radius: 8px;
        padding: 0;
        border: 1px solid #ccc;
      }
      .region-color-picker::-webkit-color-swatch {
        border-radius: 6px;
        border: none;
      }
      .region-color-picker::-moz-color-swatch {
        border-radius: 6px;
        border: none;
      }

      .region-card .remove-region-btn {
        padding: 8px 12px;
        background: #e74c3c;
        color: white;
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .region-card .remove-region-btn:hover {
        background: #c0392b;
      }

      .region-card h3 {
        color: #ff8c1a;
        margin-bottom: 15px;
        font-size: 1.2em;
      }

      @media (max-width: 768px) {
        .region-card {
          padding: 15px;
        }

        .region-card .region-header {
          flex-direction: column;
          align-items: stretch;
        }

        .region-card .region-name-input {
          width: 100%;
          min-width: 0;
        }

        .region-card .remove-region-btn {
          width: 100%;
        }
      }

      .week-selector {
        display: grid;
        gap: 10px;
      }

      .week-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        flex-wrap: wrap;
      }

      .week-item label {
        font-weight: 600;
        min-width: 60px;
        color: #555;
      }

      .week-item select {
        flex: 1;
        min-width: 120px;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .week-item {
          padding: 8px;
          gap: 8px;
        }

        .week-item label {
          min-width: 50px;
          font-size: 14px;
        }

        .week-item select {
          min-width: 0;
          flex: 1;
          font-size: 13px;
        }
      }

      .month-selector {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .month-selector input {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
      }

      .unavailable-dates {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .date-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9em;
        border: 1px solid transparent;
      }

      .date-checkbox:hover {
        background: #fff4e6;
        border-color: #ff8c1a;
      }

      .date-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .btn {
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-block;
        text-align: center;
        color: white;
      }

      .btn-primary {
        background: #ff8c1a;
        box-shadow: 0 5px 15px rgba(255, 140, 26, 0.4);
      }

      .btn-primary:hover {
        background: #e67a0a;
        box-shadow: 0 8px 20px rgba(230, 122, 10, 0.6);
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 14px;
      }

      .btn-lesson {
        background: #3498db;
        color: white;
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }

      .btn-lesson:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(41, 128, 185, 0.6);
      }

      .btn-general {
        background: #2ecc71;
        color: white;
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
      }

      .btn-general:hover {
        background: #27ae60;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(39, 174, 96, 0.6);
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .result-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .result-table th {
        background: #2a2d5f;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95em;
      }

      .result-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #ddd;
        font-size: 0.9em;
      }

      .result-table tr:hover {
        background: #f5f5f5;
      }

      .editable-cell {
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s;
      }

      .editable-cell:hover {
        background-color: #fff4e6 !important;
      }

      .edit-dropdown {
        width: 100%;
        padding: 5px;
        border: 2px solid #ff8c1a;
        border-radius: 4px;
        font-size: 0.9em;
      }

      .meeting-type {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.85em;
        font-weight: 600;
      }

      .meeting-regular {
        background: #ffe5e5;
        color: #c0392b;
      }

      .meeting-casual {
        background: #e5f5ff;
        color: #2980b9;
      }

      .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin: 20px 0;
        font-weight: 500;
      }

      .alert-success {
        background: #fff4e6;
        color: #d46b08;
        border: 2px solid #ff8c1a;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 2px solid #bee5eb;
      }

      #result {
        display: none;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(50px, 100px));
        gap: 8px;
        margin-top: 20px;
        justify-content: center;
      }

      .stat-card {
        padding: 8px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        text-align: center;
      }

      .stat-card h3 {
        color: #ff8c1a;
        font-size: 1.25em;
        margin-bottom: 4px;
      }

      .stat-card .number {
        font-size: 1em;
        font-weight: 700;
        color: #333;
      }

      .saved-schedules {
        margin-top: 20px;
      }

      .schedule-item {
        padding: 15px;
        background: white;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .schedule-item:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .schedule-info {
        flex: 1;
      }

      .schedule-info h4 {
        color: #333;
        margin-bottom: 5px;
      }

      .schedule-info p {
        color: #666;
        font-size: 0.9em;
      }

      .schedule-actions {
        display: flex;
        gap: 10px;
      }

      .compact-section {
        padding: 15px 20px;
      }

      .info-box {
        background: #fff4e6;
        border: 2px solid #ff8c1a;
        border-radius: 10px;
        padding: 12px 15px;
        margin-top: 10px;
      }

      .info-box p {
        color: #d46b08;
        margin: 0;
        font-size: 0.9em;
      }
      .config-textarea {
        width: 100%;
        height: 200px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 13px;
        font-family: "Courier New", monospace;
        resize: vertical;
        line-height: 1.5;
      }

      .config-textarea:focus {
        outline: none;
        border-color: #3498db;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <img
          src="squashus-logo.png"
          alt="SQUASHUS"
          style="height: 80px; width: auto"
        />
        <span>스케줄러</span>
      </h1>

      <div class="section">
        <h2>서버 설정</h2>

        <div id="firebaseConfigInput" style="display: none">
          <div
            style="
              background: #fff3cd;
              padding: 20px;
              border-radius: 10px;
              border: 2px solid #ffc107;
              margin-bottom: 15px;
            "
          >
            <h3 style="color: #856404; margin-bottom: 15px">
              서버 접속 정보 입력
            </h3>

            <div style="margin-bottom: 15px">
              <p style="color: #856404; font-size: 0.9em; margin-bottom: 10px">
                <strong>사용 방법:</strong> 관리자로부터 받은 서버 설정 정보를
                아래 입력창에 붙여넣기 하세요.
              </p>
              <textarea
                id="configTextarea"
                class="config-textarea"
                placeholder='const firebaseConfig = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "your-app-id",
  databaseURL: "https://your-project-default-rtdb.firebaseio.com"
};'
              ></textarea>
            </div>

            <div style="margin-bottom: 15px">
              <button
                class="btn btn-secondary btn-small"
                onclick="toggleManualInput()"
                type="button"
              >
                개별 항목으로 입력하기
              </button>
            </div>

            <div
              id="manualInputFields"
              style="display: none; margin-bottom: 15px"
            >
              <p style="color: #856404; font-size: 0.9em; margin-bottom: 10px">
                <strong>개별 입력:</strong>
              </p>
              <div style="display: grid; gap: 10px">
                <input
                  type="text"
                  id="configApiKey"
                  placeholder="API Key"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
                <input
                  type="text"
                  id="configAuthDomain"
                  placeholder="Auth Domain"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
                <input
                  type="text"
                  id="configProjectId"
                  placeholder="Project ID"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
                <input
                  type="text"
                  id="configStorageBucket"
                  placeholder="Storage Bucket"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
                <input
                  type="text"
                  id="configMessagingSenderId"
                  placeholder="Messaging Sender ID"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
                <input
                  type="text"
                  id="configAppId"
                  placeholder="App ID"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
                <input
                  type="text"
                  id="configDatabaseURL"
                  placeholder="Database URL"
                  style="
                    padding: 10px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                />
              </div>
            </div>

            <div
              style="
                margin-top: 15px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button
                class="btn btn-success btn-small"
                onclick="saveFirebaseConfig()"
                type="button"
              >
                서버 설정 저장 및 연결
              </button>
              <button
                class="btn btn-secondary btn-small"
                onclick="cancelFirebaseConfig()"
                type="button"
              >
                취소
              </button>
            </div>
          </div>
        </div>

        <div id="firebaseStatusContainer">
          <div
            id="firebaseStatus"
            class="firebase-status firebase-disconnected"
          >
            서버 연결 중...
          </div>
          <div style="margin-top: 10px; text-align: center">
            <button
              class="btn btn-secondary btn-small"
              onclick="showFirebaseConfigInput()"
              id="configBtn"
            >
              서버 설정
            </button>
            <button
              class="btn btn-secondary btn-small"
              onclick="deleteFirebaseConfig()"
              id="deleteConfigBtn"
              style="display: none"
            >
              서버 설정 삭제
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>운영진 정보 (자동 불러오기)</h2>

        <div class="staff-item">
          <span class="role-badge role-leader">모임장</span>
          <label>이름:</label>
          <input type="text" id="leader" placeholder="모임장 이름" />
        </div>

        <div style="margin-top: 20px">
          <h3 style="margin-bottom: 15px; color: #555; font-size: 1.1em">
            운영진 목록
          </h3>
          <div id="staffList" class="staff-input"></div>

          <div class="add-staff-btn">
            <button
              class="btn btn-lesson btn-small"
              onclick="addStaff('lesson')"
            >
              레슨 운영진 추가
            </button>
            <button
              class="btn btn-general btn-small"
              onclick="addStaff('general')"
            >
              일반 운영진 추가
            </button>
          </div>

          <div style="margin-top: 20px; text-align: center">
            <button class="btn btn-success" onclick="saveStaffData()">
              운영진 목록 저장
            </button>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>대상 월 선택 (월별 설정이 자동 로드됩니다)</h2>
        <div class="month-selector">
          <label for="targetMonth" style="font-weight: 600"
            >스케줄 생성할 월:</label
          >
          <input type="month" id="targetMonth" />
        </div>
        <div class="info-box">
          <p>
            <strong>안내:</strong> 월을 선택하면 해당 월에 저장된 지역/휴무일
            설정을 자동으로 불러옵니다.
          </p>
        </div>
      </div>

      <div class="two-column">
        <div class="section">
          <h2>[월별] 지역별 모임 설정</h2>

          <div id="regionList" style="display: grid; gap: 15px"></div>

          <div style="margin-top: 15px">
            <button class="btn btn-primary btn-small" onclick="addRegion()">
              지역 추가
            </button>
          </div>
        </div>

        <div class="section">
          <h2>[월별] 운영진별 불가능한 날짜</h2>
          <div id="unavailableDates"></div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-success" onclick="saveMonthSettings()">
          현재 월 설정 저장
        </button>
        <button class="btn btn-secondary" onclick="loadMonthSettings()">
          현재 월 설정 불러오기
        </button>
        <button class="btn btn-primary" onclick="generateSchedule()">
          스케줄 자동 생성
        </button>
        <button class="btn btn-secondary" onclick="resetForm()">
          현재 월 설정 초기화
        </button>
      </div>

      <div class="section" id="savedSchedulesSection" style="display: none">
        <h2>저장된 스케줄 목록</h2>
        <div id="savedSchedulesList" class="saved-schedules"></div>
      </div>

      <div id="result" class="section">
        <h2>생성된 스케줄</h2>
        <div id="resultContent"></div>
        <div class="button-group">
          <button
            class="btn btn-success"
            type="button"
            onclick="saveScheduleToFirebase()"
          >
            스케줄 저장
          </button>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
      // ============================================
      // Firebase 설정
      // ============================================
      let firebaseConfigData = null;

      // 전역 변수
      let scheduleData = [];
      let staffCounter = 0;
      let regionCounter = 0;
      let db = null;
      let firebaseConnected = false;

      // 초기화 - 현재 월을 기본값으로 설정 (사파리 호환)
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, "0");
      document.getElementById("targetMonth").value = `${year}-${month}`;

      // 월 선택 시 일요일 목록 업데이트 및 지역 카드 업데이트
      document
        .getElementById("targetMonth")
        .addEventListener("change", function () {
          updateRegionCards();
          updateSundayList();
          loadMonthSettings();
        });

      // 페이지 로드 시 기본 지역 추가 (데이터 로드 실패 시 사용)
      function addDefaultRegions() {
        document.getElementById("regionList").innerHTML = "";
        regionCounter = 0;
        updateRegionCards();
      }

      // 페이지 로드 시 기본 상태 설정
      window.addEventListener("load", function () {
        addDefaultRegions();
        updateSundayList();
        loadFirebaseConfigFromLocal();
      });

      // ============================================
      // Firebase 연결 관리
      // ============================================

      function encodeConfig(config) {
        return btoa(JSON.stringify(config));
      }

      function decodeConfig(encoded) {
        try {
          return JSON.parse(atob(encoded));
        } catch (e) {
          return null;
        }
      }

      function showFirebaseConfigInput() {
        document.getElementById("firebaseConfigInput").style.display = "block";
        document.getElementById("firebaseStatusContainer").style.display =
          "none";
      }

      function cancelFirebaseConfig() {
        document.getElementById("firebaseConfigInput").style.display = "none";
        document.getElementById("firebaseStatusContainer").style.display =
          "block";

        document.getElementById("configTextarea").value = "";
        document.getElementById("configApiKey").value = "";
        document.getElementById("configAuthDomain").value = "";
        document.getElementById("configProjectId").value = "";
        document.getElementById("configStorageBucket").value = "";
        document.getElementById("configMessagingSenderId").value = "";
        document.getElementById("configAppId").value = "";
        document.getElementById("configDatabaseURL").value = "";
      }

      function toggleManualInput() {
        const manualFields = document.getElementById("manualInputFields");
        if (manualFields.style.display === "none") {
          manualFields.style.display = "block";
        } else {
          manualFields.style.display = "none";
        }
      }

      function parseFirebaseConfig(text) {
        try {
          const config = {};

          const fields = [
            "apiKey",
            "authDomain",
            "databaseURL",
            "projectId",
            "storageBucket",
            "messagingSenderId",
            "appId",
            "measurementId",
          ];

          fields.forEach((field) => {
            const regex = new RegExp(
              field + "\\s*:\\s*[\"']([^\"']+)[\"']",
              "i"
            );
            const match = text.match(regex);
            if (match) {
              config[field] = match[1];
            }
          });

          if (!config.apiKey || !config.projectId) {
            throw new Error("필수 필드가 없습니다");
          }

          return config;
        } catch (e) {
          console.error("파싱 오류:", e);
          return null;
        }
      }

      function saveFirebaseConfig() {
        const textarea = document.getElementById("configTextarea");
        let config = null;

        if (textarea.value.trim()) {
          config = parseFirebaseConfig(textarea.value);
          if (!config) {
            alert(
              '서버 설정 형식이 올바르지 않습니다!\n\n관리자로부터 받은 설정 정보를 복사해서 붙여넣기 해주세요.\n\n예시:\nconst firebaseConfig = {\n  apiKey: "...",\n  ...\n};'
            );
            return;
          }
        } else {
          config = {
            apiKey: document.getElementById("configApiKey").value.trim(),
            authDomain: document
              .getElementById("configAuthDomain")
              .value.trim(),
            projectId: document.getElementById("configProjectId").value.trim(),
            storageBucket: document
              .getElementById("configStorageBucket")
              .value.trim(),
            messagingSenderId: document
              .getElementById("configMessagingSenderId")
              .value.trim(),
            appId: document.getElementById("configAppId").value.trim(),
            databaseURL: document
              .getElementById("configDatabaseURL")
              .value.trim(),
          };
        }

        if (!config.apiKey || !config.projectId || !config.databaseURL) {
          alert("API Key, Project ID, Database URL은 필수 항목입니다!");
          return;
        }

        const encodedConfig = encodeConfig(config);
        localStorage.setItem("firebaseConfig", encodedConfig);

        firebaseConfigData = config;
        connectFirebase();

        cancelFirebaseConfig();
      }

      function loadFirebaseConfigFromLocal() {
        const encoded = localStorage.getItem("firebaseConfig");
        if (encoded) {
          const config = decodeConfig(encoded);
          if (config) {
            firebaseConfigData = config;
            connectFirebase();
            return true;
          }
        }

        const statusDiv = document.getElementById("firebaseStatus");
        statusDiv.className = "firebase-status firebase-disconnected";
        statusDiv.innerHTML =
          "서버 미설정<br><small>설정 버튼을 눌러 서버 정보를 입력하세요</small>";
        document.getElementById("configBtn").style.display = "inline-block";
        return false;
      }

      function deleteFirebaseConfig() {
        if (
          !confirm(
            "서버 설정을 삭제하시겠습니까?\n삭제 후에는 다시 연결해야 합니다."
          )
        ) {
          return;
        }

        localStorage.removeItem("firebaseConfig");
        firebaseConfigData = null;
        firebaseConnected = false;
        db = null;

        const statusDiv = document.getElementById("firebaseStatus");
        statusDiv.className = "firebase-status firebase-disconnected";
        statusDiv.innerHTML =
          "서버 연결 해제됨<br><small>설정 버튼을 눌러 다시 연결하세요</small>";

        document.getElementById("configBtn").style.display = "inline-block";
        document.getElementById("deleteConfigBtn").style.display = "none";

        alert("서버 설정이 삭제되었습니다.");
      }

      function connectFirebase() {
        if (!firebaseConfigData) {
          console.warn("서버 설정이 없습니다.");
          return;
        }

        try {
          if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfigData);
          }
          db = firebase.database();
          firebaseConnected = true;

          const statusDiv = document.getElementById("firebaseStatus");
          statusDiv.className = "firebase-status firebase-connected";
          statusDiv.textContent = "서버 연결 완료";

          document.getElementById("configBtn").style.display = "none";
          document.getElementById("deleteConfigBtn").style.display =
            "inline-block";

          console.log("서버에 성공적으로 연결되었습니다!");

          loadSavedSchedulesList();
          loadStaffData();
        } catch (error) {
          console.error("서버 연결 오류:", error);
          const statusDiv = document.getElementById("firebaseStatus");
          statusDiv.className = "firebase-status firebase-disconnected";
          statusDiv.innerHTML = `서버 연결 실패<br><small>${error.message}</small>`;

          document.getElementById("configBtn").style.display = "inline-block";
          document.getElementById("deleteConfigBtn").style.display = "none";
        }
      }

      // ============================================
      // UI 및 날짜 관리
      // ============================================

      function getMaxWeeksInMonth() {
        const monthInput = document.getElementById("targetMonth").value;
        if (!monthInput) return 5;

        const [year, month] = monthInput.split("-").map(Number);
        const sundays = getSundaysInMonth(year, month);
        return sundays.length;
      }

      function updateRegionCards() {
        const maxWeeks = getMaxWeeksInMonth();
        const regionCards = document.querySelectorAll(".region-card");

        regionCards.forEach((card) => {
          const weekSelector = card.querySelector(".week-selector");
          const weekItems = weekSelector.querySelectorAll(".week-item");

          weekItems.forEach((item, index) => {
            const week = index + 1;
            if (week <= maxWeeks) {
              item.style.display = "flex";
            } else {
              item.style.display = "none";
            }
          });
        });
      }

      const defaultColors = [
        "#fff176",
        "#90caf9",
        "#ef9a9a",
        "#b0bec5",
        "#c8e6c9",
        "#ffd180",
      ];

      function addRegion(defaultName = "", defaultData = null) {
        regionCounter++;
        const regionList = document.getElementById("regionList");
        const regionId = `region_${regionCounter}`;

        const regionCard = document.createElement("div");
        regionCard.className = "region-card";
        regionCard.id = regionId;

        const regionHeader = document.createElement("div");
        regionHeader.className = "region-header";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "region-name-input";
        nameInput.placeholder = "지역명 입력 (예: 강남구)";
        nameInput.value = defaultName;
        nameInput.dataset.regionId = regionId;

        const colorPicker = document.createElement("input");
        colorPicker.type = "color";
        colorPicker.className = "region-color-picker";

        let color, defaultWeeks;
        if (defaultData && defaultData.color) {
          color = defaultData.color;
          defaultWeeks = defaultData.weeks;
        } else {
          color = defaultColors[regionCounter % defaultColors.length];
          defaultWeeks = defaultData;
        }
        colorPicker.value = color;

        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-region-btn";
        removeBtn.textContent = "삭제";
        removeBtn.onclick = function () {
          if (confirm("이 지역을 삭제하시겠습니까?")) {
            regionList.removeChild(regionCard);
          }
        };

        regionHeader.appendChild(nameInput);
        regionHeader.appendChild(colorPicker);
        regionHeader.appendChild(removeBtn);
        regionCard.appendChild(regionHeader);

        const weekSelector = document.createElement("div");
        weekSelector.className = "week-selector";

        const maxWeeks = getMaxWeeksInMonth();

        for (let week = 1; week <= 5; week++) {
          const weekItem = document.createElement("div");
          weekItem.className = "week-item";

          if (week > maxWeeks) {
            weekItem.style.display = "none";
          }

          const label = document.createElement("label");
          label.textContent = `${week}주차:`;

          const select = document.createElement("select");
          select.dataset.regionId = regionId;
          select.dataset.week = week;

          const options = [
            { value: "none", text: "모임 없음" },
            { value: "regular", text: "정기모임" },
            { value: "casual", text: "자율모임" },
          ];

          options.forEach((opt) => {
            const option = document.createElement("option");
            option.value = opt.value;
            option.textContent = opt.text;
            select.appendChild(option);
          });

          if (defaultWeeks && defaultWeeks[week]) {
            select.value = defaultWeeks[week];
          } else {
            select.value = "none";
          }

          weekItem.appendChild(label);
          weekItem.appendChild(select);
          weekSelector.appendChild(weekItem);
        }

        regionCard.appendChild(weekSelector);
        regionList.appendChild(regionCard);
      }

      function addStaff(type) {
        staffCounter++;
        const staffList = document.getElementById("staffList");
        const staffId = `staff_${type}_${staffCounter}`;

        const staffItem = document.createElement("div");
        staffItem.className = "staff-item";
        staffItem.id = staffId;

        const badge = document.createElement("span");
        badge.className = `role-badge role-${type}`;
        badge.textContent = type === "lesson" ? "레슨" : "일반";

        const label = document.createElement("label");
        label.textContent = "이름:";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `${
          type === "lesson" ? "레슨" : "일반"
        } 운영진 이름`;
        input.dataset.type = type;
        input.dataset.id = staffId;
        input.addEventListener("input", updateSundayList);

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "삭제";
        removeBtn.onclick = function () {
          if (confirm("이 운영진을 삭제하시겠습니까?")) {
            staffList.removeChild(staffItem);
            updateSundayList();
          }
        };

        staffItem.appendChild(badge);
        staffItem.appendChild(label);
        staffItem.appendChild(input);
        staffItem.appendChild(removeBtn);

        staffList.appendChild(staffItem);

        updateSundayList();
      }

      function getAllStaff() {
        const staff = {};

        const leaderName = document.getElementById("leader").value.trim();
        if (leaderName) {
          staff["leader"] = {
            name: leaderName,
            type: "leader",
          };
        }

        const staffInputs = document.querySelectorAll("#staffList input");
        staffInputs.forEach((input) => {
          const name = input.value.trim();
          if (name) {
            staff[input.dataset.id] = {
              name: name,
              type: input.dataset.type,
            };
          }
        });

        return staff;
      }

      function updateSundayList(unavailableDates = {}) {
        const monthInput = document.getElementById("targetMonth").value;
        if (!monthInput) return;

        const [year, month] = monthInput.split("-").map(Number);
        const sundays = getSundaysInMonth(year, month);

        const container = document.getElementById("unavailableDates");
        container.innerHTML = "";

        const allStaff = getAllStaff();

        if (Object.keys(allStaff).length === 0) {
          container.innerHTML =
            '<p style="color: #666;">운영진 정보를 먼저 입력해주세요.</p>';
          return;
        }

        const gridContainer = document.createElement("div");
        gridContainer.className = "three-column";

        Object.entries(allStaff).forEach(([staffId, staffInfo]) => {
          const staffDiv = document.createElement("div");
          staffDiv.style.padding = "15px";
          staffDiv.style.background = "white";
          staffDiv.style.borderRadius = "10px";

          const title = document.createElement("h3");
          title.textContent = staffInfo.name;
          title.style.marginBottom = "10px";
          title.style.color = "#ff8c1a";
          title.style.fontSize = "1em";
          staffDiv.appendChild(title);

          const checkboxContainer = document.createElement("div");
          checkboxContainer.className = "unavailable-dates";

          sundays.forEach((sunday) => {
            const label = document.createElement("label");
            label.className = "date-checkbox";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            const dateStr = sunday.toISOString().split("T")[0];

            checkbox.value = dateStr;
            checkbox.dataset.staff = staffId;

            if (
              unavailableDates[staffId] &&
              unavailableDates[staffId].includes(dateStr)
            ) {
              checkbox.checked = true;
            }

            const dateText = document.createElement("span");
            dateText.textContent = `${
              sunday.getMonth() + 1
            }/${sunday.getDate()}`;

            label.appendChild(checkbox);
            label.appendChild(dateText);
            checkboxContainer.appendChild(label);
          });

          staffDiv.appendChild(checkboxContainer);
          gridContainer.appendChild(staffDiv);
        });

        container.appendChild(gridContainer);
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function getSundaysInMonth(year, month) {
        const sundays = [];
        const date = new Date(year, month - 1, 1);

        while (date.getDay() !== 0) {
          date.setDate(date.getDate() + 1);
        }

        while (date.getMonth() === month - 1) {
          sundays.push(new Date(date));
          date.setDate(date.getDate() + 7);
        }

        return sundays;
      }

      function getWeekOfMonth(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const firstSunday = new Date(firstDay);
        while (firstSunday.getDay() !== 0) {
          firstSunday.setDate(firstSunday.getDate() + 1);
        }

        const diffDays = Math.floor(
          (date - firstSunday) / (1000 * 60 * 60 * 24)
        );
        return Math.floor(diffDays / 7) + 1;
      }

      function getRegionMeetings() {
        const meetings = {};
        const regionCards = document.querySelectorAll(".region-card");

        regionCards.forEach((card) => {
          const nameInput = card.querySelector(".region-name-input");
          const regionName = nameInput.value.trim();

          if (!regionName) return;

          const color = card.querySelector(".region-color-picker").value;

          const weeks = {};
          const selects = card.querySelectorAll("select");
          selects.forEach((select) => {
            const week = parseInt(select.dataset.week);
            weeks[week] = select.value;
          });

          meetings[regionName] = {
            weeks: weeks,
            color: color,
          };
        });

        return meetings;
      }

      // ============================================
      // 데이터 저장/로드
      // ============================================

      function saveStaffData() {
        if (!firebaseConnected) {
          alert("서버에 먼저 연결해주세요!");
          return;
        }

        const allStaff = getAllStaff();

        if (Object.keys(allStaff).length === 0) {
          alert("저장할 운영진 정보가 없습니다!");
          return;
        }

        db.ref("clubData/staff")
          .set(allStaff)
          .then(() => {
            alert("운영진 목록이 서버에 저장되었습니다!");
          })
          .catch((error) => {
            alert("저장 실패: " + error.message);
          });
      }

      function loadStaffData() {
        if (!firebaseConnected) {
          console.warn("서버 미연결. 운영진 로드 스킵.");
          return;
        }

        db.ref("clubData/staff")
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            if (!data) {
              console.log("저장된 운영진 정보가 없습니다.");
              loadMonthSettings();
              return;
            }

            document.getElementById("staffList").innerHTML = "";
            staffCounter = 0;

            Object.entries(data).forEach(([staffId, staffInfo]) => {
              if (staffId === "leader") {
                document.getElementById("leader").value = staffInfo.name;
              } else {
                addStaff(staffInfo.type);
                const inputs = document.querySelectorAll("#staffList input");
                const lastInput = inputs[inputs.length - 1];
                lastInput.value = staffInfo.name;
                lastInput.dataset.id = staffId;
              }
            });

            console.log("운영진 정보를 성공적으로 불러왔습니다.");

            updateSundayList();
            loadMonthSettings();
          })
          .catch((error) => {
            alert("운영진 정보 불러오기 실패: " + error.message);
          });
      }

      function saveMonthSettings() {
        if (!firebaseConnected) {
          alert("서버에 먼저 연결해주세요!");
          return;
        }
        const monthInput = document.getElementById("targetMonth").value;
        if (!monthInput) {
          alert("대상 월을 선택해주세요!");
          return;
        }

        const unavailable = {};
        document
          .querySelectorAll('input[type="checkbox"]:checked')
          .forEach((checkbox) => {
            const staffId = checkbox.dataset.staff;
            if (!unavailable[staffId]) {
              unavailable[staffId] = [];
            }
            unavailable[staffId].push(checkbox.value);
          });

        const regionMeetings = getRegionMeetings();

        const data = {
          unavailableDates: unavailable,
          regionMeetings: regionMeetings,
          updatedAt: new Date().toISOString(),
        };

        db.ref("monthlySettings/" + monthInput)
          .set(data)
          .then(() => {
            alert(`${monthInput}월 설정이 서버에 저장되었습니다!`);
          })
          .catch((error) => {
            alert("저장 실패: " + error.message);
          });
      }

      function loadMonthSettings() {
        if (!firebaseConnected) {
          console.warn("서버 미연결. 월별 설정 로드 스킵.");
          return;
        }
        const monthInput = document.getElementById("targetMonth").value;
        if (!monthInput) return;

        console.log(`${monthInput}월 설정 불러오는 중...`);

        db.ref("monthlySettings/" + monthInput)
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            if (!data) {
              console.log(
                `${monthInput}월에 저장된 설정이 없습니다. 과거 설정 검색 중...`
              );
              // 해당 월에 데이터가 없으면 과거 월 데이터 찾기
              loadPastMonthSettings(monthInput);
              return;
            }

            document.getElementById("regionList").innerHTML = "";
            regionCounter = 0;
            if (data.regionMeetings) {
              Object.entries(data.regionMeetings).forEach(
                ([regionName, regionData]) => {
                  addRegion(regionName, regionData);
                }
              );
              updateRegionCards();
            } else {
              addDefaultRegions();
            }

            updateSundayList(data.unavailableDates || {});
            console.log(`${monthInput}월 설정을 불러왔습니다!`);
          })
          .catch((error) => {
            alert("월별 설정 불러오기 실패: " + error.message);
          });
      }

      // 가장 가까운 과거 월의 설정을 찾아서 로드
      function loadPastMonthSettings(currentMonth) {
        db.ref("monthlySettings")
          .once("value")
          .then((snapshot) => {
            const allSettings = snapshot.val();

            if (!allSettings) {
              console.log("저장된 월별 설정이 전혀 없습니다.");
              addDefaultRegions();
              updateSundayList();
              return;
            }

            // 현재 선택된 월보다 이전인 월들만 필터링
            const pastMonths = Object.keys(allSettings)
              .filter((month) => month < currentMonth)
              .sort()
              .reverse(); // 최신순 정렬

            if (pastMonths.length === 0) {
              console.log("과거 설정을 찾을 수 없습니다.");
              addDefaultRegions();
              updateSundayList();
              return;
            }

            // 가장 최근 과거 월의 데이터 사용
            const nearestPastMonth = pastMonths[0];
            const pastData = allSettings[nearestPastMonth];

            console.log(
              `${nearestPastMonth}월의 설정을 불러왔습니다. (${currentMonth}월에 적용)`
            );

            document.getElementById("regionList").innerHTML = "";
            regionCounter = 0;

            // 지역 설정만 가져오기 (휴무일은 가져오지 않음)
            if (pastData.regionMeetings) {
              Object.entries(pastData.regionMeetings).forEach(
                ([regionName, regionData]) => {
                  addRegion(regionName, regionData);
                }
              );
              updateRegionCards();

              // 사용자에게 알림
              alert(
                `${currentMonth}월 설정이 없어 ${nearestPastMonth}월의 지역 설정을 불러왔습니다.\n휴무일은 초기화되었으니 다시 설정해주세요.`
              );
            } else {
              addDefaultRegions();
            }

            // 휴무일은 비워둠 (과거 월의 휴무일을 가져오지 않음)
            updateSundayList();
          })
          .catch((error) => {
            console.error("과거 설정 불러오기 실패:", error);
            addDefaultRegions();
            updateSundayList();
          });
      }

      // ============================================
      // 스케줄 생성 로직
      // ============================================

      function generateSchedule() {
        const allStaff = getAllStaff();

        const assignmentCounts = {};
        Object.keys(allStaff).forEach((id) => {
          assignmentCounts[id] = 0;
        });

        if (!allStaff["leader"]) {
          alert("모임장 이름을 입력해주세요!");
          return;
        }

        const partnerStaffList = Object.entries(allStaff).filter(
          ([id, info]) => info.type === "general" || info.type === "lesson"
        );
        if (partnerStaffList.length === 0) {
          alert("일반 또는 레슨 운영진을 최소 1명 이상 추가해주세요!");
          return;
        }

        const monthInput = document.getElementById("targetMonth").value;
        if (!monthInput) {
          alert("대상 월을 선택해주세요!");
          return;
        }

        const unavailable = {};
        Object.keys(allStaff).forEach((id) => {
          unavailable[id] = [];
        });

        document
          .querySelectorAll('input[type="checkbox"]:checked')
          .forEach((checkbox) => {
            const staffId = checkbox.dataset.staff;
            unavailable[staffId].push(checkbox.value);
          });

        const [year, month] = monthInput.split("-").map(Number);
        const sundays = getSundaysInMonth(year, month);
        const regionMeetings = getRegionMeetings();

        const meetings = [];
        sundays.forEach((sunday) => {
          const week = getWeekOfMonth(sunday);

          const y = sunday.getFullYear();
          const m = String(sunday.getMonth() + 1).padStart(2, "0");
          const d = String(sunday.getDate()).padStart(2, "0");
          const dateStr = `${y}-${m}-${d}`;

          Object.entries(regionMeetings).forEach(([regionName, regionData]) => {
            const meetingType = regionData.weeks[week];
            if (meetingType && meetingType !== "none") {
              meetings.push({
                date: dateStr,
                region: regionName,
                type: meetingType === "regular" ? "정기" : "자율",
                week,
              });
            }
          });
        });

        meetings.sort((a, b) => {
          if (a.date !== b.date) {
            return new Date(a.date) - new Date(b.date);
          }
          if (a.type === "정기" && b.type !== "정기") {
            return -1;
          }
          if (a.type !== "정기" && b.type === "정기") {
            return 1;
          }
          return 0;
        });

        const assignments = [];
        const weeklyAssignments = {};

        for (let meeting of meetings) {
          const { date, region, type, week } = meeting;

          if (!weeklyAssignments[week]) {
            weeklyAssignments[week] = new Set();
          }

          if (type === "정기") {
            let assigned = false;
            const leaderAvailable = !unavailable["leader"].includes(date);

            if (!leaderAvailable || weeklyAssignments[week].has("leader")) {
              assignments.push({
                date,
                region,
                type,
                week,
                staff: "배치 불가 (모임장 불가 또는 중복)",
                staffType: "none",
              });
              continue;
            }

            let availablePartners = partnerStaffList.filter(
              ([id, info]) =>
                !unavailable[id].includes(date) &&
                !weeklyAssignments[week].has(id)
            );

            if (availablePartners.length > 0) {
              availablePartners = shuffleArray(availablePartners);
              availablePartners.sort(
                (a, b) => assignmentCounts[a[0]] - assignmentCounts[b[0]]
              );
              const [assignedStaffId, assignedStaffInfo] = availablePartners[0];

              assignments.push({
                date,
                region,
                type,
                week,
                staff: `${allStaff["leader"].name}, ${assignedStaffInfo.name}`,
                staffType: assignedStaffInfo.type,
              });

              weeklyAssignments[week].add("leader");
              weeklyAssignments[week].add(assignedStaffId);
              assignmentCounts["leader"]++;
              assignmentCounts[assignedStaffId]++;
              assigned = true;
            }

            if (!assigned) {
              assignments.push({
                date,
                region,
                type,
                week,
                staff: `${allStaff["leader"].name}, 파트너 배치 불가`,
                staffType: "none",
              });
              weeklyAssignments[week].add("leader");
              assignmentCounts["leader"]++;
            }
          } else {
            let assigned = false;
            let availableStaff = Object.entries(allStaff).filter(
              ([id, info]) =>
                !unavailable[id].includes(date) &&
                !weeklyAssignments[week].has(id)
            );

            if (availableStaff.length > 0) {
              availableStaff = shuffleArray(availableStaff);
              availableStaff.sort(
                (a, b) => assignmentCounts[a[0]] - assignmentCounts[b[0]]
              );
              const [assignedStaffId, assignedStaffInfo] = availableStaff[0];

              assignments.push({
                date,
                region,
                type,
                week,
                staff: assignedStaffInfo.name,
                staffType: assignedStaffInfo.type,
              });

              weeklyAssignments[week].add(assignedStaffId);
              assignmentCounts[assignedStaffId]++;
              assigned = true;
            }

            if (!assigned) {
              assignments.push({
                date,
                region,
                type,
                week,
                staff: "배치 불가",
                staffType: "none",
              });
            }
          }
        }

        scheduleData = assignments;
        displayResults(assignments, year, month);
      }

      function displayResults(assignments, year, month) {
        const resultDiv = document.getElementById("resultContent");
        const stats = calculateStats(assignments);

        const [targetYear, targetMonth] = document
          .getElementById("targetMonth")
          .value.split("-")
          .map(Number);
        const sundays = getSundaysInMonth(targetYear, targetMonth);

        const regionSettings = getRegionMeetings();
        const allRegionNames = Object.keys(regionSettings);

        const totalMeetings = assignments.length;
        const failedCount = assignments.filter((a) =>
          a.staff.includes("배치 불가")
        ).length;

        const fallbackColors = ["#fff176", "#90caf9", "#ef9a9a", "#b0bec5"];

        let html = `
        <div class="alert alert-success">
            ${year}년 ${month}월 스케줄이 생성되었습니다! (총 ${totalMeetings}건, 배정 실패 ${failedCount}건)
        </div>
        
        <div class="stats">
            ${Object.entries(stats)
              .map(
                ([name, count]) => `
                <div class="stat-card">
                    <h3>${name}</h3>
                    <div class="number">${count}회</div>
                </div>
            `
              )
              .join("")}
        </div>
        
        <table class="result-table" style="border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;">
            <thead>
                <tr>
                    <th rowspan="2" style="border: 1px solid #ddd; padding: 8px; width: 120px; vertical-align: middle; text-align: center;">날짜</th>
    `;

        allRegionNames.forEach((region, i) => {
          const color = regionSettings[region]
            ? regionSettings[region].color
            : fallbackColors[i % fallbackColors.length];
          html += `<th colspan="2" style="border: 1px solid #ddd; padding: 8px; background-color: ${color}; text-align: center;">${region}</th>`;
        });
        html += `</tr><tr>`;
        html += `</tr></thead><tbody>`;

        sundays.forEach((sunday) => {
          const [y, m, d] = [
            sunday.getFullYear(),
            sunday.getMonth() + 1,
            sunday.getDate(),
          ];
          const dateStr = `${y}-${String(m).padStart(2, "0")}-${String(
            d
          ).padStart(2, "0")}`;
          const displayDate = `${y}. ${m}. ${d}`;

          html += `<tr><td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; text-align: center;">${displayDate}</td>`;

          allRegionNames.forEach((region) => {
            const assignment = assignments.find(
              (a) => a.date === dateStr && a.region === region
            );

            if (assignment) {
              let typeStr = "";
              let staffStr = assignment.staff;

              if (assignment.staff.includes("배치 불가")) {
                typeStr = "배치실패";
                staffStr = "";
              } else {
                if (assignment.type === "정기") {
                  typeStr = "정기모임";
                } else {
                  typeStr =
                    assignment.staffType === "lesson"
                      ? "자율(레슨O)"
                      : "자율(레슨X)";
                }
              }

              // 수정 가능한 셀로 만들기
              html += `
                    <td class="editable-cell" style="border: 1px solid #ddd; padding: 8px; text-align: center;" 
                        onclick="editMeetingType('${dateStr}', '${region}')">${typeStr}</td>
                    <td class="editable-cell" style="border: 1px solid #ddd; padding: 8px; text-align: center;" 
                        onclick="editStaff('${dateStr}', '${region}')">${staffStr}</td>
                `;
            } else {
              html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;"></td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;"></td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table>`;

        resultDiv.innerHTML = html;
        document.getElementById("result").style.display = "block";
        document
          .getElementById("result")
          .scrollIntoView({ behavior: "smooth" });
      }

      // ============================================
      // 스케줄 수정 기능
      // ============================================

      function editMeetingType(date, region) {
        const assignment = scheduleData.find(
          (a) => a.date === date && a.region === region
        );

        if (!assignment) {
          alert("해당 날짜에 모임이 없습니다.");
          return;
        }

        const cell = event.target;
        const originalContent = cell.textContent;

        // contenteditable로 변경
        cell.contentEditable = true;
        cell.style.backgroundColor = "#fff8dc";
        cell.style.outline = "2px solid #ff8c1a";
        cell.focus();

        // 텍스트 전체 선택
        const range = document.createRange();
        range.selectNodeContents(cell);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        let isSaved = false;

        const saveChanges = () => {
          if (isSaved) return;
          isSaved = true;

          cell.contentEditable = false;
          cell.style.backgroundColor = "";
          cell.style.outline = "";

          const newText = cell.textContent.trim();

          // 입력값에 따라 모임 유형 결정
          if (newText.includes("정기") || newText === "정기모임") {
            assignment.type = "정기";
            cell.textContent = "정기모임";
          } else if (
            newText.includes("레슨O") ||
            newText.includes("레슨o") ||
            newText === "자율(레슨O)"
          ) {
            assignment.type = "자율";
            assignment.staffType = "lesson";
            cell.textContent = "자율(레슨O)";
          } else if (
            newText.includes("레슨X") ||
            newText.includes("레슨x") ||
            newText === "자율(레슨X)"
          ) {
            assignment.type = "자율";
            assignment.staffType = "general";
            cell.textContent = "자율(레슨X)";
          } else if (newText.includes("배치") || newText.includes("불가")) {
            cell.textContent = "배치실패";
          } else {
            // 잘못된 입력
            cell.textContent = originalContent;
            return;
          }

          const [year, month] = document
            .getElementById("targetMonth")
            .value.split("-")
            .map(Number);
          displayResults(scheduleData, year, month);
        };

        const cancelEdit = () => {
          if (isSaved) return;
          isSaved = true;

          cell.contentEditable = false;
          cell.style.backgroundColor = "";
          cell.style.outline = "";
          cell.textContent = originalContent;
        };

        const keydownHandler = (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            cell.removeEventListener("keydown", keydownHandler);
            cell.removeEventListener("blur", blurHandler);
            saveChanges();
          } else if (e.key === "Escape") {
            e.preventDefault();
            cell.removeEventListener("keydown", keydownHandler);
            cell.removeEventListener("blur", blurHandler);
            cancelEdit();
          }
        };

        const blurHandler = () => {
          cell.removeEventListener("keydown", keydownHandler);
          saveChanges();
        };

        cell.addEventListener("keydown", keydownHandler);
        cell.addEventListener("blur", blurHandler);
      }

      function editStaff(date, region) {
        const assignment = scheduleData.find(
          (a) => a.date === date && a.region === region
        );

        if (!assignment || assignment.staff.includes("배치 불가")) {
          alert("담당자를 배정할 수 없는 일정입니다.");
          return;
        }

        const allStaff = getAllStaff();
        const cell = event.target;
        const originalContent = cell.textContent;

        // contenteditable로 변경
        cell.contentEditable = true;
        cell.style.backgroundColor = "#fff8dc";
        cell.style.outline = "2px solid #ff8c1a";
        cell.focus();

        // 텍스트 전체 선택
        const range = document.createRange();
        range.selectNodeContents(cell);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        let isSaved = false;

        const saveChanges = () => {
          if (isSaved) return;
          isSaved = true;

          cell.contentEditable = false;
          cell.style.backgroundColor = "";
          cell.style.outline = "";

          const newText = cell.textContent.trim();

          if (!newText) {
            cell.textContent = originalContent;
            return;
          }

          // 쉼표로 구분된 이름들 처리
          const names = newText
            .split(",")
            .map((n) => n.trim())
            .filter((n) => n);

          // 입력된 이름이 운영진 목록에 있는지 확인
          const validNames = [];
          names.forEach((name) => {
            const staffEntry = Object.entries(allStaff).find(
              ([id, info]) =>
                info.name === name ||
                info.name.includes(name) ||
                name.includes(info.name)
            );
            if (staffEntry) {
              validNames.push(staffEntry[1].name);
            }
          });

          if (validNames.length === 0) {
            alert(
              "올바른 운영진 이름을 입력해주세요.\n쉼표(,)로 구분하여 여러 명을 입력할 수 있습니다."
            );
            cell.textContent = originalContent;
            return;
          }

          assignment.staff = validNames.join(", ");

          // staffType 업데이트 (자율모임이고 1명인 경우)
          if (assignment.type === "자율" && validNames.length === 1) {
            const staffEntry = Object.entries(allStaff).find(
              ([id, info]) => info.name === validNames[0]
            );
            if (staffEntry) {
              assignment.staffType = staffEntry[1].type;
            }
          }

          const [year, month] = document
            .getElementById("targetMonth")
            .value.split("-")
            .map(Number);
          displayResults(scheduleData, year, month);
        };

        const cancelEdit = () => {
          if (isSaved) return;
          isSaved = true;

          cell.contentEditable = false;
          cell.style.backgroundColor = "";
          cell.style.outline = "";
          cell.textContent = originalContent;
        };

        const keydownHandler = (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            cell.removeEventListener("keydown", keydownHandler);
            cell.removeEventListener("blur", blurHandler);
            saveChanges();
          } else if (e.key === "Escape") {
            e.preventDefault();
            cell.removeEventListener("keydown", keydownHandler);
            cell.removeEventListener("blur", blurHandler);
            cancelEdit();
          }
        };

        const blurHandler = () => {
          cell.removeEventListener("keydown", keydownHandler);
          saveChanges();
        };

        cell.addEventListener("keydown", keydownHandler);
        cell.addEventListener("blur", blurHandler);
      }

      function calculateStats(assignments) {
        const stats = {};

        assignments.forEach((item) => {
          if (item.staff.includes("배치 불가")) return;

          const names = item.staff.split(",").map((n) => n.trim());
          names.forEach((name) => {
            stats[name] = (stats[name] || 0) + 1;
          });
        });

        return stats;
      }

      // ============================================
      // 저장된 스케줄 (결과) 관리
      // ============================================

      function saveScheduleToFirebase() {
        if (!firebaseConnected) {
          alert("서버에 먼저 연결해주세요!");
          return;
        }

        if (scheduleData.length === 0) {
          alert("저장할 스케줄이 없습니다!");
          return;
        }

        const monthInput = document.getElementById("targetMonth").value;
        const [year, month] = monthInput.split("-");

        const performSave = () => {
          const scheduleId = `${year}_${month}_${Date.now()}`;

          const scheduleToSave = {
            id: scheduleId,
            year: parseInt(year),
            month: parseInt(month),
            data: scheduleData,
            createdAt: new Date().toISOString(),
          };

          db.ref("schedules/" + scheduleId)
            .set(scheduleToSave)
            .then(() => {
              alert("스케줄이 서버에 새 버전으로 저장되었습니다!");
              loadSavedSchedulesList();
            })
            .catch((error) => {
              alert("저장 실패: " + error.message);
            });
        };

        const query = db
          .ref("schedules")
          .orderByChild("id")
          .startAt(`${year}_${month}`)
          .endAt(`${year}_${month}\uf8ff`);

        query
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              if (
                confirm(
                  `"${year}년 ${month}월" 스케줄이 이미 저장되어 있습니다.\n새로운 버전으로 추가 저장하시겠습니까?`
                )
              ) {
                performSave();
              } else {
                alert("저장이 취소되었습니다.");
              }
            } else {
              performSave();
            }
          })
          .catch((error) => {
            alert("스케줄 확인 중 오류 발생: " + error.message);
          });
      }

      function loadSavedSchedulesList() {
        if (!firebaseConnected) return;

        db.ref("schedules")
          .once("value")
          .then((snapshot) => {
            const schedules = snapshot.val();
            if (!schedules) {
              document.getElementById("savedSchedulesSection").style.display =
                "none";
              return;
            }

            const schedulesList = document.getElementById("savedSchedulesList");
            schedulesList.innerHTML = "";

            Object.entries(schedules).forEach(([id, schedule]) => {
              const scheduleItem = document.createElement("div");
              scheduleItem.className = "schedule-item";

              const info = document.createElement("div");
              info.className = "schedule-info";

              const title = document.createElement("h4");
              title.textContent = `${schedule.year}년 ${schedule.month}월 스케줄`;

              const date = document.createElement("p");
              const createdDate = new Date(schedule.createdAt);
              date.textContent = `저장일: ${createdDate.toLocaleDateString(
                "ko-KR"
              )} ${createdDate.toLocaleTimeString("ko-KR")}`;

              info.appendChild(title);
              info.appendChild(date);

              const actions = document.createElement("div");
              actions.className = "schedule-actions";

              const loadBtn = document.createElement("button");
              loadBtn.className = "btn btn-primary btn-small";
              loadBtn.textContent = "불러오기";
              loadBtn.onclick = () => loadScheduleFromFirebase(id);

              const deleteBtn = document.createElement("button");
              deleteBtn.className = "btn btn-secondary btn-small";
              deleteBtn.textContent = "삭제";
              deleteBtn.onclick = () => deleteScheduleFromFirebase(id);

              actions.appendChild(loadBtn);
              actions.appendChild(deleteBtn);

              scheduleItem.appendChild(info);
              scheduleItem.appendChild(actions);

              schedulesList.appendChild(scheduleItem);
            });

            document.getElementById("savedSchedulesSection").style.display =
              "block";
          })
          .catch((error) => {
            console.error("스케줄 목록 불러오기 실패:", error);
          });
      }

      function loadScheduleFromFirebase(scheduleId) {
        db.ref("schedules/" + scheduleId)
          .once("value")
          .then((snapshot) => {
            const schedule = snapshot.val();
            if (!schedule) {
              alert("스케줄을 찾을 수 없습니다!");
              return;
            }

            document.getElementById("targetMonth").value = `${
              schedule.year
            }-${String(schedule.month).padStart(2, "0")}`;

            scheduleData = schedule.data;
            displayResults(scheduleData, schedule.year, schedule.month);

            alert("스케줄을 불러왔습니다!");
          })
          .catch((error) => {
            alert("불러오기 실패: " + error.message);
          });
      }

      function deleteScheduleFromFirebase(scheduleId) {
        if (!confirm("이 스케줄을 삭제하시겠습니까?")) return;

        db.ref("schedules/" + scheduleId)
          .remove()
          .then(() => {
            alert("스케줄이 삭제되었습니다!");
            loadSavedSchedulesList();
          })
          .catch((error) => {
            alert("삭제 실패: " + error.message);
          });
      }

      function resetForm() {
        if (
          confirm(
            "현재 월의 설정(지역, 불가능한 날짜)을 초기화하시겠습니까?\n(운영진 목록은 유지됩니다)"
          )
        ) {
          document.getElementById("regionList").innerHTML = "";
          document
            .querySelectorAll('input[type="checkbox"]')
            .forEach((checkbox) => (checkbox.checked = false));
          document.getElementById("result").style.display = "none";

          scheduleData = [];
          regionCounter = 0;

          addDefaultRegions();
        }
      }
    </script>
  </body>
</html>
