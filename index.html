<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ë™í˜¸íšŒ ìŠ¤ì¼€ì¤„ ìë™ ë°°ì¹˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .three-column {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            .section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .section h2 {
                font-size: 1.2em;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .btn-small {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .button-group .btn {
                width: 100%;
            }
            
            .add-staff-btn {
                flex-direction: column;
            }
            
            .add-staff-btn .btn {
                width: 100%;
            }
            
            .month-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .month-selector input {
                width: 100%;
            }
            
            .result-table {
                font-size: 0.85em;
            }
            
            .result-table th,
            .result-table td {
                padding: 8px 6px;
            }
            
            .schedule-item {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .schedule-actions {
                flex-direction: column;
            }
            
            .schedule-actions .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            
            .section h2 {
                font-size: 1.1em;
            }
            
            .role-badge {
                font-size: 0.75em;
                padding: 4px 8px;
            }
            
            .unavailable-dates {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .date-checkbox {
                padding: 6px;
                font-size: 0.85em;
            }
        }
        
        .firebase-status {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            font-size: 1.1em;
        }
        
        .firebase-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .firebase-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .staff-input {
            display: grid;
            gap: 15px;
        }
        
        .staff-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .staff-item label {
            font-weight: 600;
            min-width: 80px;
            color: #555;
        }
        
        .staff-item input {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .staff-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .staff-item button {
            padding: 8px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .staff-item button:hover {
            background: #c0392b;
        }
        
        @media (max-width: 768px) {
            .staff-item {
                gap: 10px;
                padding: 12px;
            }
            
            .staff-item .role-badge {
                order: 1;
                width: 100%;
                text-align: center;
            }
            
            .staff-item label {
                order: 2;
                min-width: 60px;
            }
            
            .staff-item input {
                order: 3;
                flex: 1;
                min-width: 0;
                width: 100%;
            }
            
            .staff-item button {
                order: 4;
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        .role-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            min-width: 60px;
            text-align: center;
        }
        
        .role-leader {
            background: #e74c3c;
        }
        
        .role-lesson {
            background: #3498db;
        }
        
        .role-general {
            background: #2ecc71;
        }
        
        .add-staff-btn {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .region-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .region-card .region-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .region-card .region-name-input {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
        }
        
        .region-card .region-name-input:focus {
            outline: none;
            border-color: #764ba2;
        }
        
        .region-card .remove-region-btn {
            padding: 8px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .region-card .remove-region-btn:hover {
            background: #c0392b;
        }
        
        .region-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .region-card {
                padding: 15px;
            }
            
            .region-card .region-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .region-card .region-name-input {
                width: 100%;
                min-width: 0;
            }
            
            .region-card .remove-region-btn {
                width: 100%;
            }
        }
        
        .week-selector {
            display: grid;
            gap: 10px;
        }
        
        .week-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .week-item label {
            font-weight: 600;
            min-width: 60px;
            color: #555;
        }
        
        .week-item select {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .week-item {
                padding: 8px;
                gap: 8px;
            }
            
            .week-item label {
                min-width: 50px;
                font-size: 14px;
            }
            
            .week-item select {
                min-width: 0;
                flex: 1;
                font-size: 13px;
            }
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .month-selector input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .unavailable-dates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .date-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9em;
        }
        
        .date-checkbox:hover {
            background: #f0f0f0;
        }
        
        .date-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .result-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .result-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }
        
        .result-table tr:hover {
            background: #f5f5f5;
        }
        
        .meeting-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .meeting-regular {
            background: #ffe5e5;
            color: #c0392b;
        }
        
        .meeting-casual {
            background: #e5f5ff;
            color: #2980b9;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        #result {
            display: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        
        .stat-card .number {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
        }
        
        .saved-schedules {
            margin-top: 20px;
        }
        
        .schedule-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .schedule-item:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .schedule-info {
            flex: 1;
        }
        
        .schedule-info h4 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .schedule-info p {
            color: #666;
            font-size: 0.9em;
        }
        
        .schedule-actions {
            display: flex;
            gap: 10px;
        }
        
        .compact-section {
            padding: 15px 20px;
        }
        
        .info-box {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 12px 15px;
            margin-top: 10px;
        }
        
        .info-box p {
            color: #0d47a1;
            margin: 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—“ï¸ ë™í˜¸íšŒ ìŠ¤ì¼€ì¤„ ìë™ ë°°ì¹˜</h1>
        
        <!-- Firebase ì„¤ì • ë° ìƒíƒœ -->
        <div class="section">
            <h2>ğŸ”¥ Firebase ì„¤ì •</h2>
            
            <div id="firebaseConfigInput" style="display: none;">
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 15px;">
                    <h3 style="color: #856404; margin-bottom: 15px;">Firebase í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥</h3>
                    <div style="display: grid; gap: 10px;">
                        <input type="text" id="configApiKey" placeholder="API Key" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <input type="text" id="configAuthDomain" placeholder="Auth Domain (ì˜ˆ: project-id.firebaseapp.com)" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <input type="text" id="configProjectId" placeholder="Project ID" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <input type="text" id="configStorageBucket" placeholder="Storage Bucket (ì˜ˆ: project-id.appspot.com)" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <input type="text" id="configMessagingSenderId" placeholder="Messaging Sender ID" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <input type="text" id="configAppId" placeholder="App ID" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <input type="text" id="configDatabaseURL" placeholder="Database URL (ì˜ˆ: https://project-id-default-rtdb.firebaseio.com)" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-small" onclick="saveFirebaseConfig()">ğŸ’¾ ì„¤ì • ì €ì¥ ë° ì—°ê²°</button>
                        <button class="btn btn-secondary btn-small" onclick="cancelFirebaseConfig()">âŒ ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
            
            <div id="firebaseStatusContainer">
                <div id="firebaseStatus" class="firebase-status firebase-disconnected">
                    ğŸ”„ Firebase ì—°ê²° ì¤‘...
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button class="btn btn-secondary btn-small" onclick="showFirebaseConfigInput()" id="configBtn">âš™ï¸ Firebase ì„¤ì •</button>
                    <button class="btn btn-secondary btn-small" onclick="deleteFirebaseConfig()" id="deleteConfigBtn" style="display: none;">ğŸ—‘ï¸ ì„¤ì • ì‚­ì œ</button>
                </div>
            </div>
        </div>
        
        <!-- ëŒ€ìƒ ì›” ì„ íƒ (ìµœìš°ì„ ) -->
        <div class="section">
            <h2>ğŸ“… ëŒ€ìƒ ì›” ì„ íƒ (ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!)</h2>
            <div class="month-selector">
                <label for="targetMonth" style="font-weight: 600;">ìŠ¤ì¼€ì¤„ ìƒì„±í•  ì›”:</label>
                <input type="month" id="targetMonth">
            </div>
            <div class="info-box">
                <p><strong>ğŸ’¡ ì•ˆë‚´:</strong> ëŒ€ìƒ ì›”ì„ ë¨¼ì € ì„ íƒí•˜ë©´ í•´ë‹¹ ì›”ì˜ ì¼ìš”ì¼ ê°œìˆ˜ì— ë§ì¶° ì§€ì—­ë³„ ì£¼ì°¨ ì„¤ì •ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
        
        <!-- 2ë‹¨ ë ˆì´ì•„ì›ƒ: ìš´ì˜ì§„ ì •ë³´ + ì§€ì—­ë³„ ëª¨ì„ ì„¤ì • -->
        <div class="two-column">
            <!-- ì™¼ìª½: ìš´ì˜ì§„ ì •ë³´ -->
            <div class="section">
                <h2>ğŸ‘¥ ìš´ì˜ì§„ ì •ë³´</h2>
                
                <div class="staff-item" style="background: #ffe5e5;">
                    <span class="role-badge role-leader">ëª¨ì„ì¥</span>
                    <label>ì´ë¦„:</label>
                    <input type="text" id="leader" placeholder="ëª¨ì„ì¥ ì´ë¦„">
                </div>
                
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #555; font-size: 1.1em;">ìš´ì˜ì§„ ëª©ë¡</h3>
                    <div id="staffList" class="staff-input"></div>
                    
                    <div class="add-staff-btn">
                        <button class="btn btn-primary btn-small" onclick="addStaff('lesson')">â• ë ˆìŠ¨ ìš´ì˜ì§„</button>
                        <button class="btn btn-primary btn-small" onclick="addStaff('general')">â• ì¼ë°˜ ìš´ì˜ì§„</button>
                    </div>
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ì§€ì—­ë³„ ëª¨ì„ ì„¤ì • -->
            <div class="section">
                <h2>ğŸ“ ì§€ì—­ë³„ ëª¨ì„ ì„¤ì •</h2>
                
                <div id="regionList" style="display: grid; gap: 15px;">
                    <!-- ì§€ì—­ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary btn-small" onclick="addRegion()">â• ì§€ì—­ ì¶”ê°€</button>
                </div>
            </div>
        </div>
        
        <!-- ë¶ˆê°€ëŠ¥í•œ ë‚ ì§œ ì„ íƒ -->
        <div class="section">
            <h2>âŒ ìš´ì˜ì§„ë³„ ë¶ˆê°€ëŠ¥í•œ ì¼ìš”ì¼</h2>
            <div id="unavailableDates"></div>
        </div>
        
        <!-- ì €ì¥ ë° ìƒì„± ë²„íŠ¼ -->
        <div class="button-group">
            <button class="btn btn-success" onclick="saveAllData()">ğŸ’¾ ìš´ì˜ì§„ ì •ë³´ ë° ì„¤ì • ì €ì¥</button>
            <button class="btn btn-secondary" onclick="loadAllData()">ğŸ“‚ ì €ì¥ëœ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn btn-primary" onclick="generateSchedule()">âœ¨ ìŠ¤ì¼€ì¤„ ìë™ ìƒì„±</button>
            <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
        
        <!-- ì €ì¥ëœ ìŠ¤ì¼€ì¤„ ëª©ë¡ -->
        <div class="section" id="savedSchedulesSection" style="display: none;">
            <h2>ğŸ“š ì €ì¥ëœ ìŠ¤ì¼€ì¤„ ëª©ë¡</h2>
            <div id="savedSchedulesList" class="saved-schedules"></div>
        </div>
        
        <!-- ê²°ê³¼ -->
        <div id="result" class="section">
            <h2>ğŸ“‹ ìƒì„±ëœ ìŠ¤ì¼€ì¤„</h2>
            <div id="resultContent"></div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="downloadSchedule()">ğŸ’¾ CSV ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success" onclick="saveScheduleToFirebase()">â˜ï¸ Firebaseì— ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        // ============================================
        // Firebase ì„¤ì •
        // ============================================
        let firebaseConfigData = null;
        
        // ì „ì—­ ë³€ìˆ˜
        let scheduleData = [];
        let staffCounter = 0;
        let regionCounter = 0;
        let db = null;
        let firebaseConnected = false;
        
        // ì´ˆê¸°í™”
        document.getElementById('targetMonth').valueAsDate = new Date();
        
        // ì›” ì„ íƒ ì‹œ ì¼ìš”ì¼ ëª©ë¡ ì—…ë°ì´íŠ¸ ë° ì§€ì—­ ì¹´ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('targetMonth').addEventListener('change', function() {
            updateRegionCards();
            updateSundayList();
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¼ìš”ì¼ ëª©ë¡ ìƒì„±
        window.addEventListener('load', updateSundayList);
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì§€ì—­ ì¶”ê°€
        window.addEventListener('load', function() {
            // ê¸°ë³¸ ì§€ì—­ 3ê°œ ì¶”ê°€
            addRegion('ì¤‘ë‘êµ¬', {1: 'casual', 2: 'casual', 3: 'regular', 4: 'casual', 5: 'none'});
            addRegion('ê¸ˆì²œêµ¬', {1: 'none', 2: 'casual', 3: 'none', 4: 'regular', 5: 'none'});
            addRegion('ì†¡íŒŒêµ¬', {1: 'regular', 2: 'none', 3: 'casual', 4: 'casual', 5: 'none'});
            
            // ì´ˆê¸° ë¡œë“œ ì‹œ ì£¼ì°¨ ì—…ë°ì´íŠ¸
            updateRegionCards();
        });
        
        // Firebase ìë™ ì—°ê²°
        function connectFirebase() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.warn('Firebase ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                const statusDiv = document.getElementById('firebaseStatus');
                statusDiv.className = 'firebase-status firebase-disconnected';
                statusDiv.innerHTML = 'âŒ Firebase ë¯¸ì„¤ì • (ì½”ë“œì—ì„œ ì„¤ì • í•„ìš”)';
                return;
            }
            
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database();
                firebaseConnected = true;
                
                const statusDiv = document.getElementById('firebaseStatus');
                statusDiv.className = 'firebase-status firebase-connected';
                statusDiv.textContent = 'âœ… Firebase ì—°ê²° ì™„ë£Œ';
                
                loadSavedSchedulesList();
                
            } catch (error) {
                console.error('Firebase ì—°ê²° ì˜¤ë¥˜:', error);
                const statusDiv = document.getElementById('firebaseStatus');
                statusDiv.className = 'firebase-status firebase-disconnected';
                statusDiv.innerHTML = `âŒ Firebase ì—°ê²° ì‹¤íŒ¨`;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ Firebase ì—°ê²°
        window.addEventListener('load', function() {
            loadFirebaseConfigFromLocal();
        });
        
        // ê°„ë‹¨í•œ ì•”í˜¸í™” (Base64 ì¸ì½”ë”©)
        function encodeConfig(config) {
            return btoa(JSON.stringify(config));
        }
        
        // ê°„ë‹¨í•œ ë³µí˜¸í™” (Base64 ë””ì½”ë”©)
        function decodeConfig(encoded) {
            try {
                return JSON.parse(atob(encoded));
            } catch (e) {
                return null;
            }
        }
        
        // Firebase ì„¤ì • ì…ë ¥ í™”ë©´ í‘œì‹œ
        function showFirebaseConfigInput() {
            document.getElementById('firebaseConfigInput').style.display = 'block';
            document.getElementById('firebaseStatusContainer').style.display = 'none';
        }
        
        // Firebase ì„¤ì • ì…ë ¥ ì·¨ì†Œ
        function cancelFirebaseConfig() {
            document.getElementById('firebaseConfigInput').style.display = 'none';
            document.getElementById('firebaseStatusContainer').style.display = 'block';
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('configApiKey').value = '';
            document.getElementById('configAuthDomain').value = '';
            document.getElementById('configProjectId').value = '';
            document.getElementById('configStorageBucket').value = '';
            document.getElementById('configMessagingSenderId').value = '';
            document.getElementById('configAppId').value = '';
            document.getElementById('configDatabaseURL').value = '';
        }
        
        // Firebase ì„¤ì • ì €ì¥
        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('configApiKey').value.trim(),
                authDomain: document.getElementById('configAuthDomain').value.trim(),
                projectId: document.getElementById('configProjectId').value.trim(),
                storageBucket: document.getElementById('configStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('configMessagingSenderId').value.trim(),
                appId: document.getElementById('configAppId').value.trim(),
                databaseURL: document.getElementById('configDatabaseURL').value.trim()
            };
            
            // í•„ìˆ˜ í•­ëª© ê²€ì¦
            if (!config.apiKey || !config.projectId || !config.databaseURL) {
                alert('API Key, Project ID, Database URLì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤!');
                return;
            }
            
            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì•”í˜¸í™”í•´ì„œ ì €ì¥
            const encodedConfig = encodeConfig(config);
            localStorage.setItem('firebaseConfig', encodedConfig);
            
            // Firebase ì—°ê²° ì‹œë„
            firebaseConfigData = config;
            connectFirebase();
            
            // UI ì •ë¦¬
            cancelFirebaseConfig();
        }
        
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ Firebase ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadFirebaseConfigFromLocal() {
            const encoded = localStorage.getItem('firebaseConfig');
            if (encoded) {
                const config = decodeConfig(encoded);
                if (config) {
                    firebaseConfigData = config;
                    connectFirebase();
                    return true;
                }
            }
            
            // ì„¤ì •ì´ ì—†ìœ¼ë©´ ì…ë ¥ ìš”ì²­
            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.className = 'firebase-status firebase-disconnected';
            statusDiv.innerHTML = 'âŒ Firebase ë¯¸ì„¤ì •<br><small>ì„¤ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ Firebase ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>';
            document.getElementById('configBtn').style.display = 'inline-block';
            return false;
        }
        
        // Firebase ì„¤ì • ì‚­ì œ
        function deleteFirebaseConfig() {
            if (!confirm('Firebase ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.')) {
                return;
            }
            
            localStorage.removeItem('firebaseConfig');
            firebaseConfigData = null;
            firebaseConnected = false;
            db = null;
            
            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.className = 'firebase-status firebase-disconnected';
            statusDiv.innerHTML = 'âŒ Firebase ì—°ê²° í•´ì œë¨<br><small>ì„¤ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì—°ê²°í•˜ì„¸ìš”</small>';
            
            document.getElementById('configBtn').style.display = 'inline-block';
            document.getElementById('deleteConfigBtn').style.display = 'none';
            
            alert('Firebase ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // Firebase ìë™ ì—°ê²°
        function connectFirebase() {
            if (!firebaseConfigData) {
                console.warn('Firebase ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfigData);
                }
                db = firebase.database();
                firebaseConnected = true;
                
                const statusDiv = document.getElementById('firebaseStatus');
                statusDiv.className = 'firebase-status firebase-connected';
                statusDiv.textContent = 'âœ… Firebase ì—°ê²° ì™„ë£Œ';
                
                document.getElementById('configBtn').style.display = 'none';
                document.getElementById('deleteConfigBtn').style.display = 'inline-block';
                
                console.log('Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                loadSavedSchedulesList();
                
            } catch (error) {
                console.error('Firebase ì—°ê²° ì˜¤ë¥˜:', error);
                const statusDiv = document.getElementById('firebaseStatus');
                statusDiv.className = 'firebase-status firebase-disconnected';
                statusDiv.innerHTML = `âŒ Firebase ì—°ê²° ì‹¤íŒ¨<br><small>${error.message}</small>`;
                
                document.getElementById('configBtn').style.display = 'inline-block';
                document.getElementById('deleteConfigBtn').style.display = 'none';
            }
        }
        
        // í•´ë‹¹ ì›”ì˜ ì¼ìš”ì¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        function getMaxWeeksInMonth() {
            const monthInput = document.getElementById('targetMonth').value;
            if (!monthInput) return 5; // ê¸°ë³¸ê°’
            
            const [year, month] = monthInput.split('-').map(Number);
            const sundays = getSundaysInMonth(year, month);
            return sundays.length;
        }
        
        // ëª¨ë“  ì§€ì—­ ì¹´ë“œì˜ ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateRegionCards() {
            const maxWeeks = getMaxWeeksInMonth();
            const regionCards = document.querySelectorAll('.region-card');
            
            regionCards.forEach(card => {
                const weekSelector = card.querySelector('.week-selector');
                const weekItems = weekSelector.querySelectorAll('.week-item');
                
                weekItems.forEach((item, index) => {
                    const week = index + 1;
                    if (week <= maxWeeks) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
        
        // ì§€ì—­ ì¶”ê°€
        function addRegion(defaultName = '', defaultWeeks = null) {
            regionCounter++;
            const regionList = document.getElementById('regionList');
            const regionId = `region_${regionCounter}`;
            
            const regionCard = document.createElement('div');
            regionCard.className = 'region-card';
            regionCard.id = regionId;
            
            const regionHeader = document.createElement('div');
            regionHeader.className = 'region-header';
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'region-name-input';
            nameInput.placeholder = 'ì§€ì—­ëª… ì…ë ¥ (ì˜ˆ: ê°•ë‚¨êµ¬)';
            nameInput.value = defaultName;
            nameInput.dataset.regionId = regionId;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-region-btn';
            removeBtn.textContent = 'âŒ ì‚­ì œ';
            removeBtn.onclick = function() {
                if (confirm('ì´ ì§€ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    regionList.removeChild(regionCard);
                }
            };
            
            regionHeader.appendChild(nameInput);
            regionHeader.appendChild(removeBtn);
            regionCard.appendChild(regionHeader);
            
            const weekSelector = document.createElement('div');
            weekSelector.className = 'week-selector';
            
            const maxWeeks = getMaxWeeksInMonth();
            
            for (let week = 1; week <= 5; week++) {
                const weekItem = document.createElement('div');
                weekItem.className = 'week-item';
                
                // í•´ë‹¹ ì›”ì˜ ì£¼ì°¨ ìˆ˜ë³´ë‹¤ ë§ìœ¼ë©´ ìˆ¨ê¸°ê¸°
                if (week > maxWeeks) {
                    weekItem.style.display = 'none';
                }
                
                const label = document.createElement('label');
                label.textContent = `${week}ì£¼ì°¨:`;
                
                const select = document.createElement('select');
                select.dataset.regionId = regionId;
                select.dataset.week = week;
                
                const options = [
                    { value: 'none', text: 'ëª¨ì„ ì—†ìŒ' },
                    { value: 'regular', text: 'ì •ê¸°ëª¨ì„' },
                    { value: 'casual', text: 'ììœ¨ëª¨ì„' }
                ];
                
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    select.appendChild(option);
                });
                
                // ê¸°ë³¸ê°’ ì„¤ì •
                if (defaultWeeks && defaultWeeks[week]) {
                    select.value = defaultWeeks[week];
                } else {
                    select.value = 'none';
                }
                
                weekItem.appendChild(label);
                weekItem.appendChild(select);
                weekSelector.appendChild(weekItem);
            }
            
            regionCard.appendChild(weekSelector);
            regionList.appendChild(regionCard);
        }
        
        // ìš´ì˜ì§„ ì¶”ê°€
        function addStaff(type) {
            staffCounter++;
            const staffList = document.getElementById('staffList');
            const staffId = `staff_${type}_${staffCounter}`;
            
            const staffItem = document.createElement('div');
            staffItem.className = 'staff-item';
            staffItem.id = staffId;
            
            const badge = document.createElement('span');
            badge.className = `role-badge role-${type}`;
            badge.textContent = type === 'lesson' ? 'ë ˆìŠ¨' : 'ì¼ë°˜';
            
            const label = document.createElement('label');
            label.textContent = 'ì´ë¦„:';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `${type === 'lesson' ? 'ë ˆìŠ¨' : 'ì¼ë°˜'} ìš´ì˜ì§„ ì´ë¦„`;
            input.dataset.type = type;
            input.dataset.id = staffId;
            input.addEventListener('input', updateSundayList);
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'âŒ';
            removeBtn.onclick = function() {
                if (confirm('ì´ ìš´ì˜ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    staffList.removeChild(staffItem);
                    updateSundayList();
                }
            };
            
            staffItem.appendChild(badge);
            staffItem.appendChild(label);
            staffItem.appendChild(input);
            staffItem.appendChild(removeBtn);
            
            staffList.appendChild(staffItem);
            
            updateSundayList();
        }
        
        function getAllStaff() {
            const staff = {};
            
            const leaderName = document.getElementById('leader').value.trim();
            if (leaderName) {
                staff['leader'] = {
                    name: leaderName,
                    type: 'leader'
                };
            }
            
            const staffInputs = document.querySelectorAll('#staffList input');
            staffInputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    staff[input.dataset.id] = {
                        name: name,
                        type: input.dataset.type
                    };
                }
            });
            
            return staff;
        }
        
        function updateSundayList() {
            const monthInput = document.getElementById('targetMonth').value;
            if (!monthInput) return;
            
            const [year, month] = monthInput.split('-').map(Number);
            const sundays = getSundaysInMonth(year, month);
            
            const container = document.getElementById('unavailableDates');
            container.innerHTML = '';
            
            const allStaff = getAllStaff();
            
            if (Object.keys(allStaff).length === 0) {
                container.innerHTML = '<p style="color: #666;">ìš´ì˜ì§„ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
                return;
            }
            
            // 3ë‹¨ ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜
            const gridContainer = document.createElement('div');
            gridContainer.className = 'three-column';
            
            Object.entries(allStaff).forEach(([staffId, staffInfo]) => {
                const staffDiv = document.createElement('div');
                staffDiv.style.padding = '15px';
                staffDiv.style.background = 'white';
                staffDiv.style.borderRadius = '10px';
                
                const title = document.createElement('h3');
                title.textContent = staffInfo.name;
                title.style.marginBottom = '10px';
                title.style.color = '#667eea';
                title.style.fontSize = '1em';
                staffDiv.appendChild(title);
                
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'unavailable-dates';
                
                sundays.forEach(sunday => {
                    const label = document.createElement('label');
                    label.className = 'date-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = sunday.toISOString().split('T')[0];
                    checkbox.dataset.staff = staffId;
                    
                    const dateText = document.createElement('span');
                    dateText.textContent = `${sunday.getMonth() + 1}/${sunday.getDate()}`;
                    
                    label.appendChild(checkbox);
                    label.appendChild(dateText);
                    checkboxContainer.appendChild(label);
                });
                
                staffDiv.appendChild(checkboxContainer);
                gridContainer.appendChild(staffDiv);
            });
            
            container.appendChild(gridContainer);
        }
        
        function getSundaysInMonth(year, month) {
            const sundays = [];
            const date = new Date(year, month - 1, 1);
            
            while (date.getDay() !== 0) {
                date.setDate(date.getDate() + 1);
            }
            
            while (date.getMonth() === month - 1) {
                sundays.push(new Date(date));
                date.setDate(date.getDate() + 7);
            }
            
            return sundays;
        }
        
        function getWeekOfMonth(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const firstSunday = new Date(firstDay);
            while (firstSunday.getDay() !== 0) {
                firstSunday.setDate(firstSunday.getDate() + 1);
            }
            
            const diffDays = Math.floor((date - firstSunday) / (1000 * 60 * 60 * 24));
            return Math.floor(diffDays / 7) + 1;
        }
        
        function getRegionMeetings() {
            const meetings = {};
            
            // ëª¨ë“  ì§€ì—­ ì¹´ë“œ ì°¾ê¸°
            const regionCards = document.querySelectorAll('.region-card');
            
            regionCards.forEach(card => {
                const nameInput = card.querySelector('.region-name-input');
                const regionName = nameInput.value.trim();
                
                if (!regionName) return; // ì§€ì—­ëª…ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                
                const regionId = nameInput.dataset.regionId;
                meetings[regionName] = {};
                
                // í•´ë‹¹ ì§€ì—­ì˜ ëª¨ë“  ì£¼ì°¨ ì„ íƒê°’ ê°€ì ¸ì˜¤ê¸°
                const selects = card.querySelectorAll('select');
                selects.forEach(select => {
                    const week = parseInt(select.dataset.week);
                    meetings[regionName][week] = select.value;
                });
            });
            
            return meetings;
        }
        
        function generateSchedule() {
            const allStaff = getAllStaff();
            
            if (!allStaff['leader']) {
                alert('ëª¨ì„ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const generalStaff = Object.entries(allStaff).filter(([id, info]) => info.type === 'general');
            if (generalStaff.length === 0) {
                alert('ì¼ë°˜ ìš´ì˜ì§„ì„ ìµœì†Œ 1ëª… ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const monthInput = document.getElementById('targetMonth').value;
            if (!monthInput) {
                alert('ëŒ€ìƒ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const unavailable = {};
            Object.keys(allStaff).forEach(id => {
                unavailable[id] = [];
            });
            
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                const staffId = checkbox.dataset.staff;
                unavailable[staffId].push(checkbox.value);
            });
            
            const [year, month] = monthInput.split('-').map(Number);
            const sundays = getSundaysInMonth(year, month);
            
            const regionMeetings = getRegionMeetings();
            
            const meetings = [];
            sundays.forEach(sunday => {
                const week = getWeekOfMonth(sunday);
                const dateStr = sunday.toISOString().split('T')[0];
                
                Object.entries(regionMeetings).forEach(([regionName, weeks]) => {
                    const meetingType = weeks[week];
                    if (meetingType && meetingType !== 'none') {
                        meetings.push({
                            date: dateStr,
                            region: regionName,
                            type: meetingType === 'regular' ? 'ì •ê¸°' : 'ììœ¨',
                            week
                        });
                    }
                });
            });
            
            const assignments = [];
            const weeklyAssignments = {};
            
            for (let meeting of meetings) {
                const { date, region, type, week } = meeting;
                
                if (!weeklyAssignments[week]) {
                    weeklyAssignments[week] = new Set();
                }
                
                if (type === 'ì •ê¸°') {
                    const leaderAvailable = !unavailable['leader'].includes(date);
                    
                    if (!leaderAvailable) {
                        assignments.push({
                            date,
                            region,
                            type,
                            staff: 'âŒ ë°°ì¹˜ ë¶ˆê°€ (ëª¨ì„ì¥ ë¶ˆê°€)',
                            week
                        });
                        continue;
                    }
                    
                    const generalStaffIds = Object.entries(allStaff)
                        .filter(([id, info]) => info.type === 'general')
                        .map(([id]) => id);
                    
                    let assigned = false;
                    
                    for (let staffId of generalStaffIds) {
                        if (!unavailable[staffId].includes(date) && !weeklyAssignments[week].has(staffId)) {
                            assignments.push({
                                date,
                                region,
                                type,
                                staff: `${allStaff['leader'].name}, ${allStaff[staffId].name}`,
                                week
                            });
                            weeklyAssignments[week].add('leader');
                            weeklyAssignments[week].add(staffId);
                            assigned = true;
                            break;
                        }
                    }
                    
                    if (!assigned) {
                        assignments.push({
                            date,
                            region,
                            type,
                            staff: `${allStaff['leader'].name}, âŒ ì¼ë°˜ ìš´ì˜ì§„ ë°°ì¹˜ ë¶ˆê°€`,
                            week
                        });
                        weeklyAssignments[week].add('leader');
                    }
                } else {
                    let assigned = false;
                    
                    for (let [staffId, staffInfo] of Object.entries(allStaff)) {
                        if (!unavailable[staffId].includes(date) && !weeklyAssignments[week].has(staffId)) {
                            assignments.push({
                                date,
                                region,
                                type,
                                staff: staffInfo.name,
                                week
                            });
                            weeklyAssignments[week].add(staffId);
                            assigned = true;
                            break;
                        }
                    }
                    
                    if (!assigned) {
                        assignments.push({
                            date,
                            region,
                            type,
                            staff: 'âŒ ë°°ì¹˜ ë¶ˆê°€',
                            week
                        });
                    }
                }
            }
            
            displayResults(assignments, year, month);
            scheduleData = assignments;
        }
        
        function displayResults(assignments, year, month) {
            const resultDiv = document.getElementById('resultContent');
            
            const stats = calculateStats(assignments);
            
            let html = `
                <div class="alert alert-success">
                    âœ… ${year}ë…„ ${month}ì›” ìŠ¤ì¼€ì¤„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
                </div>
                
                <div class="stats">
                    ${Object.entries(stats).map(([name, count]) => `
                        <div class="stat-card">
                            <h3>${name}</h3>
                            <div class="number">${count}íšŒ</div>
                        </div>
                    `).join('')}
                </div>
                
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì£¼ì°¨</th>
                            <th>ì§€ì—­</th>
                            <th>ëª¨ì„ ìœ í˜•</th>
                            <th>ë°°ì¹˜ ìš´ì˜ì§„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            assignments.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            assignments.forEach(item => {
                const date = new Date(item.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                
                html += `
                    <tr>
                        <td><strong>${dateStr}</strong></td>
                        <td>${item.week}ì£¼ì°¨</td>
                        <td><strong>${item.region}</strong></td>
                        <td><span class="meeting-type meeting-${item.type === 'ì •ê¸°' ? 'regular' : 'casual'}">${item.type}ëª¨ì„</span></td>
                        <td>${item.staff}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            resultDiv.innerHTML = html;
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }
        
        function calculateStats(assignments) {
            const stats = {};
            
            assignments.forEach(item => {
                if (item.staff.includes('âŒ')) return;
                
                const names = item.staff.split(',').map(n => n.trim());
                names.forEach(name => {
                    stats[name] = (stats[name] || 0) + 1;
                });
            });
            
            return stats;
        }
        
        function downloadSchedule() {
            if (scheduleData.length === 0) return;
            
            let csv = 'ë‚ ì§œ,ì£¼ì°¨,ì§€ì—­,ëª¨ì„ìœ í˜•,ë°°ì¹˜ìš´ì˜ì§„\n';
            
            scheduleData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            scheduleData.forEach(item => {
                const date = new Date(item.date);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                csv += `${dateStr},${item.week}ì£¼ì°¨,${item.region},${item.type}ëª¨ì„,${item.staff}\n`;
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const monthInput = document.getElementById('targetMonth').value;
            const [year, month] = monthInput.split('-');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ë™í˜¸íšŒ_ìŠ¤ì¼€ì¤„_${year}ë…„${month}ì›”.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function saveAllData() {
            if (!firebaseConnected) {
                alert('Firebaseì— ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”! ì½”ë“œì—ì„œ Firebase ì„¤ì •ì„ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const allStaff = getAllStaff();
            
            if (Object.keys(allStaff).length === 0) {
                alert('ì €ì¥í•  ìš´ì˜ì§„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const unavailable = {};
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                const staffId = checkbox.dataset.staff;
                if (!unavailable[staffId]) {
                    unavailable[staffId] = [];
                }
                unavailable[staffId].push(checkbox.value);
            });
            
            const regionMeetings = getRegionMeetings();
            
            const data = {
                staff: allStaff,
                unavailableDates: unavailable,
                regionMeetings: regionMeetings,
                targetMonth: document.getElementById('targetMonth').value,
                updatedAt: new Date().toISOString()
            };
            
            db.ref('clubData').set(data)
                .then(() => {
                    alert('âœ… ìš´ì˜ì§„ ì •ë³´ ë° ì„¤ì •ì´ Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                })
                .catch((error) => {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                });
        }
        
        function loadAllData() {
            if (!firebaseConnected) {
                alert('Firebaseì— ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”! ì½”ë“œì—ì„œ Firebase ì„¤ì •ì„ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            db.ref('clubData').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (!data) {
                        alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                        return;
                    }
                    
                    // ìš´ì˜ì§„ ì •ë³´ ì´ˆê¸°í™” ë° ë³µì›
                    document.getElementById('staffList').innerHTML = '';
                    staffCounter = 0;
                    
                    if (data.staff) {
                        Object.entries(data.staff).forEach(([staffId, staffInfo]) => {
                            if (staffId === 'leader') {
                                document.getElementById('leader').value = staffInfo.name;
                            } else {
                                addStaff(staffInfo.type);
                                const inputs = document.querySelectorAll('#staffList input');
                                const lastInput = inputs[inputs.length - 1];
                                lastInput.value = staffInfo.name;
                                lastInput.dataset.id = staffId;
                            }
                        });
                    }
                    
                    // ì§€ì—­ ì •ë³´ ì´ˆê¸°í™” ë° ë³µì›
                    document.getElementById('regionList').innerHTML = '';
                    regionCounter = 0;
                    
                    if (data.regionMeetings) {
                        Object.entries(data.regionMeetings).forEach(([regionName, weeks]) => {
                            addRegion(regionName, weeks);
                        });
                        // ì§€ì—­ ë³µì› í›„ ì£¼ì°¨ ì—…ë°ì´íŠ¸
                        updateRegionCards();
                    }
                    
                    if (data.targetMonth) {
                        document.getElementById('targetMonth').value = data.targetMonth;
                    }
                    
                    updateSundayList();
                    
                    setTimeout(() => {
                        if (data.unavailableDates) {
                            Object.entries(data.unavailableDates).forEach(([staffId, dates]) => {
                                dates.forEach(date => {
                                    const checkbox = document.querySelector(`input[type="checkbox"][value="${date}"][data-staff="${staffId}"]`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                    }
                                });
                            });
                        }
                        
                        alert('âœ… ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    }, 500);
                })
                .catch((error) => {
                    alert('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
                });
        }
        
        function saveScheduleToFirebase() {
            if (!firebaseConnected) {
                alert('Firebaseì— ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (scheduleData.length === 0) {
                alert('ì €ì¥í•  ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const monthInput = document.getElementById('targetMonth').value;
            const [year, month] = monthInput.split('-');
            const scheduleId = `${year}_${month}_${Date.now()}`;
            
            const scheduleToSave = {
                id: scheduleId,
                year: parseInt(year),
                month: parseInt(month),
                data: scheduleData,
                createdAt: new Date().toISOString()
            };
            
            db.ref('schedules/' + scheduleId).set(scheduleToSave)
                .then(() => {
                    alert('âœ… ìŠ¤ì¼€ì¤„ì´ Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    loadSavedSchedulesList();
                })
                .catch((error) => {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                });
        }
        
        function loadSavedSchedulesList() {
            if (!firebaseConnected) return;
            
            db.ref('schedules').once('value')
                .then((snapshot) => {
                    const schedules = snapshot.val();
                    if (!schedules) {
                        document.getElementById('savedSchedulesSection').style.display = 'none';
                        return;
                    }
                    
                    const schedulesList = document.getElementById('savedSchedulesList');
                    schedulesList.innerHTML = '';
                    
                    Object.entries(schedules).forEach(([id, schedule]) => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        
                        const info = document.createElement('div');
                        info.className = 'schedule-info';
                        
                        const title = document.createElement('h4');
                        title.textContent = `${schedule.year}ë…„ ${schedule.month}ì›” ìŠ¤ì¼€ì¤„`;
                        
                        const date = document.createElement('p');
                        const createdDate = new Date(schedule.createdAt);
                        date.textContent = `ì €ì¥ì¼: ${createdDate.toLocaleDateString('ko-KR')} ${createdDate.toLocaleTimeString('ko-KR')}`;
                        
                        info.appendChild(title);
                        info.appendChild(date);
                        
                        const actions = document.createElement('div');
                        actions.className = 'schedule-actions';
                        
                        const loadBtn = document.createElement('button');
                        loadBtn.className = 'btn btn-primary btn-small';
                        loadBtn.textContent = 'ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°';
                        loadBtn.onclick = () => loadScheduleFromFirebase(id);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-secondary btn-small';
                        deleteBtn.textContent = 'ğŸ—‘ï¸';
                        deleteBtn.onclick = () => deleteScheduleFromFirebase(id);
                        
                        actions.appendChild(loadBtn);
                        actions.appendChild(deleteBtn);
                        
                        scheduleItem.appendChild(info);
                        scheduleItem.appendChild(actions);
                        
                        schedulesList.appendChild(scheduleItem);
                    });
                    
                    document.getElementById('savedSchedulesSection').style.display = 'block';
                })
                .catch((error) => {
                    console.error('ìŠ¤ì¼€ì¤„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                });
        }
        
        function loadScheduleFromFirebase(scheduleId) {
            db.ref('schedules/' + scheduleId).once('value')
                .then((snapshot) => {
                    const schedule = snapshot.val();
                    if (!schedule) {
                        alert('ìŠ¤ì¼€ì¤„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                        return;
                    }
                    
                    document.getElementById('targetMonth').value = `${schedule.year}-${String(schedule.month).padStart(2, '0')}`;
                    
                    scheduleData = schedule.data;
                    displayResults(scheduleData, schedule.year, schedule.month);
                    
                    alert('âœ… ìŠ¤ì¼€ì¤„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                })
                .catch((error) => {
                    alert('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
                });
        }
        
        function deleteScheduleFromFirebase(scheduleId) {
            if (!confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            db.ref('schedules/' + scheduleId).remove()
                .then(() => {
                    alert('âœ… ìŠ¤ì¼€ì¤„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    loadSavedSchedulesList();
                })
                .catch((error) => {
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                });
        }
        
        function resetForm() {
            if (confirm('ëª¨ë“  ì…ë ¥ ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('leader').value = '';
                document.getElementById('staffList').innerHTML = '';
                document.getElementById('regionList').innerHTML = '';
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                document.getElementById('result').style.display = 'none';
                scheduleData = [];
                staffCounter = 0;
                regionCounter = 0;
                
                // ê¸°ë³¸ ì§€ì—­ 3ê°œ ë‹¤ì‹œ ì¶”ê°€
                addRegion('ì¤‘ë‘êµ¬', {1: 'casual', 2: 'casual', 3: 'regular', 4: 'casual', 5: 'none'});
                addRegion('ê¸ˆì²œêµ¬', {1: 'none', 2: 'casual', 3: 'none', 4: 'regular', 5: 'none'});
                addRegion('ì†¡íŒŒêµ¬', {1: 'regular', 2: 'none', 3: 'casual', 4: 'casual', 5: 'none'});
            }
        }
    </script>
</body>
</html>